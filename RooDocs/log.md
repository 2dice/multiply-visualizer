# 開発ログ

## Step 1 (2025/03/09)

### うまくいった手法

- `npm create vite@latest my-project -- --template react` コマンドで、Vite と React を使用したプロジェクトを正常に作成できた。
- `cd my-project && npm install && npm run dev` コマンドで、依存関係のインストールと開発サーバーの起動ができた。
- 開発サーバー起動後、ブラウザで `http://localhost:5173/` にアクセスし、初期ページが表示されることを確認できた。

### 今後の留意点

- 特になし。

## Step 2 (2025/03/09)

### うまくいった手法

- `vite.config.js` に `base: './'` と `build: { outDir: '../docs' }` を設定することで、GitHub Pages での公開に成功した。
- `package.json` に `"homepage": "https://2dice.github.io/multiply-visualizer/"` を追加することで、GitHub Pages での公開に対応できた。
- `cd my-project && npm run build && cd .. && git add docs && git commit -m "Deploy to GitHub Pages with docs folder" && git push origin main` コマンドで、`docs` ディレクトリをGitHub Pages にデプロイできた。

### 今後の留意点

- `git add` するディレクトリを間違えないように注意する。

## Step 3 (2025/03/09)

### うまくいった手法

- `cd my-project && npm install --save-dev eslint prettier eslint-plugin-react eslint-config-prettier` コマンドで、ESLintとPrettier、関連パッケージをインストールできた。
- `.eslintrc.cjs` ファイルを作成し、ESLintの設定を記述できた。
- `.prettierrc.cjs` ファイルを作成し、Prettierの設定を記述できた。
- `package.json` に `lint` と `format` スクリプトを追加し、`build` スクリプトに `npm run lint && npm run format` を追加できた。
- `npm run lint` と `npm run format` コマンドが正常に実行できることを確認できた。

### 今後の留意点

- 特になし。

## Step 4 (2025/03/09)

### うまくいった手法

- `cd my-project && npm install -D playwright @playwright/test` コマンドで、Playwrightとテストフレームワークをインストールできた。
- `npx playwright install` コマンドで、必要なブラウザをインストールできた。
- `my-project/tests/example.spec.ts` ファイルを作成し、簡単なテストを記述できた。
- `cd my-project && npx playwright test` コマンドで、テストを実行し、成功することを確認できた。

### 今後の留意点

- コマンド実行時に`&amp;&amp;`ではなく`&&`を使用する。
- `npm run dev` はユーザーが実行し、`npx playwright test` はRooが実行する。

## Step 5 (2025/03/23)

### うまくいった手法

- `src/components/UI/`ディレクトリを作成し、`Tab.jsx`、`Slider.jsx`、`Button.jsx`を作成できた。
- `src/App.jsx`を修正し、作成したコンポーネントを表示できた。
- `tests/example.spec.ts`を修正し、コンソールエラーのチェック、UIコンポーネントの表示確認、基本的な操作のテストを追加できた。
- `npx playwright test`でテストが成功することを確認できた。
- `eslint.config.js`の`ignores`に`docs/assets/*`を追加することで、ビルドファイルのエラーを無視できた。
- `.eslintrc.cjs`が不要であることを確認し、削除できた。

### 今後の留意点

- 特になし。

## Step 5.1 (2025/03/23)

### うまくいった手法

- `design.md` の UI 改善の仕様に従い、`Slider.jsx` と `Button.jsx` を修正できた。
- `Slider.jsx` に、左右の矢印ボタンと、スタイル調整用の CSS を追加できた。
- `Button.jsx` に、スタイル調整用の CSS を追加できた。
- `App.jsx` を修正し、`Slider` コンポーネントに `onIncrease` と `onDecrease` の props を渡すように変更できた。
- `tests/example.spec.ts` を修正し、UI 改善後の `Slider` と `Button` の表示と動作を確認するテストを追加できた。
- `npx playwright test` でテストが成功することを確認できた (最終的には `toBeCloseTo` を使用して誤差を許容するように修正)。
- `Slider.css` に `box-sizing: border-box;` を追加し、padding を含めた幅で要素のサイズを計算するように修正した (結果的に `width` を `320px` に修正する必要があった)。
- `App.jsx` の重複 import 文を削除し、lint エラーを解消した。
- `Slider.jsx` にデバッグ用の表示を追加し、offsetWidth と clientWidth の値を確認することで、CSS が適用されていない原因を特定しようとした (最終的には CSS が適用されていたが、`box-sizing` の理解不足が原因と判明)。
- スライダーの値が 0 の位置で上矢印ボタンを押すと値が異常に増加していくバグを修正した。
- スライダーのボタンをテキストから SVG アイコンに変更し、スタイル (青地、白アイコン、丸み、影) を適用した。
- `tests/example.spec.ts` の `sliderButtonWidth` の期待値を `toBeCloseTo(40, 0)` から `toBeCloseTo(30, 0)` に修正した。

### 今後の留意点

- CSS のスタイリングはまだ仮のものなので、今後デザインに合わせて調整する必要がある。
- Slider の increase/decrease のテストで、初期値が 50 であることを前提にしているが、これは `App.jsx` の `useState` の初期値に依存しているので、変更があった場合にテストが失敗する可能性がある。初期値を props で渡すように変更するか、テスト内で初期値を設定するように変更することを検討する。
- `box-sizing: border-box;` の理解を深め、CSS の設計に活かす。
- Playwright のテストで、offsetWidth や clientWidth のような数値の比較を行う場合は、誤差を考慮して `toBeCloseTo` を使用することを検討する。

## Step 6.1 (2025/03/30)

### うまくいった手法

- `src/components/GridTab.jsx` を作成し、基本的な UI 要素（ラベル、スライダー、表示エリア）を配置できた。
- `src/App.jsx` を修正し、`GridTab` コンポーネントをタブ UI に組み込めた。
- `tests/gridTab.spec.ts` を作成し、グリッドタブの UI 要素が表示されることを確認する Playwright テストを記述できた。
- 開発サーバーのエラーログとブラウザコンソールを確認し、`GridTab.jsx` のインポートパスの間違いを特定・修正できた。
- Playwright の Strict Mode 違反エラーを解決するため、タブの特定方法を `locator('.tab', { hasText: '...' })` から `getByRole('button', { name: '...', exact: true })` に変更した。
- Playwright の `getByLabel` が機能しない原因を特定するため、`Slider.jsx` を確認し、`id` プロパティの受け渡しと設定が漏れていたことを発見・修正できた。
- Playwright のテストで `getByLabel` を使用するように修正し、スライダー要素の特定をより堅牢にした。
- ユーザーの目視確認で発覚したレイアウトの問題（ラベルとスライダーが縦に並ぶ）を、`GridTab.jsx` に CSS クラスを追加し、`App.css` に Flexbox を使ったスタイルを定義することで解決できた。
- 最終的に、`npm run lint`, `npm run format`, `npx playwright test` がすべて成功することを確認できた。

### 今後の留意点

- Playwright テストで要素が見つからない場合、セレクタの問題だけでなく、開発サーバーのエラーや React コンポーネントのレンダリングエラーも疑う必要がある。
- `getByLabel` を使用する場合、対象の入力要素に正しく `id` が設定され、`<label>` の `htmlFor` と一致していることを確認する。
- UI のレイアウト調整には CSS (Flexbox や Grid など) の知識が必要になる。
- 長時間の中断後は、開発サーバーが停止している可能性があるので、再開時に確認する。

## Step 6.2 (2025/04/05)

### うまくいった手法

- `src/App.css` の `#root` から `max-width`, `margin: auto` を削除し、`src/index.css` の `body` から `display: flex`, `place-items: center` を削除して、アプリ全体の幅制限と中央寄せを解除した。
- `src/App.css` に `.tabs-container` スタイルを追加し、タブメニューを中央揃えにした。
- `src/components/GridTab.jsx` の構造を変更し、`src/App.css` に Flexbox と Grid Layout を使用したスタイルを追加して、グリッド表示エリアとスライダーを配置した（グリッドエリア拡大、スライダー左右配置、ラベルをスライダー上部中央に）。
- `src/components/UI/Slider.css` の `.slider-container` の `width` を `100%` に変更し、スライダーのレスポンシブ対応を行った。
- `src/App.css` の `.slider-label`, `.result-text` の `font-size` に `clamp()` を使用し、テキストサイズのレスポンシブ対応を行った。
- `tests/gridTab.spec.ts` を修正し、レイアウト変更（Grid Layout, `align-items: center`）とレスポンシブ対応（`font-size` の `clamp()`）に対応するアサーションを追加・修正した。
- `apply_diff` が不安定だったため、`write_to_file` を使用して CSS とテストファイルを確実に更新した。
- 複数回のテストとユーザーによる目視確認を繰り返し、レイアウトの問題（縦スクロールバー、要素間のスペース、レスポンシブ）を段階的に修正した。
- 最終的に、`npm run lint`, `npm run format`, `npx playwright test` がすべて成功し、ユーザーの目視確認でも問題がないことを確認できた。

### 今後の留意点

- `apply_diff` が失敗する場合は、コンテキスト行数を調整するか、`write_to_file` での全体上書きを検討する。
- Playwright で CSS の計算値（`rem` や `clamp()` の結果）をテストする場合、具体的なピクセル値ではなく、範囲やパターン（正規表現）でアサーションを行う必要がある。
- 複雑なレイアウト調整では、一度に多くの変更を加えるのではなく、段階的に修正し、都度テストと目視確認を行う方が確実である。
- レスポンシブ対応では、テキストだけでなく、他の UI 要素（スライダー、ボタンなど）のサイズも画面サイズに応じて調整することを検討する。

## Step 6.3 (2025/04/06)

### うまくいった手法

- `src/components/GridTab.jsx` にスライダーの値を管理する完全な状態管理を実装した。
  - `useState` を使用して行数（rows）、列数（cols）、積（product）の状態を管理。
  - `useEffect` を使用して、行数または列数が変更された時に自動的に積を計算・更新。
  - スライダーの値変更ハンドラー（`handleRowsChange`、`handleColsChange`）を実装。
  - スライダーの矢印ボタン用の増減ハンドラー（`handleRowsIncrease`、`handleRowsDecrease`、`handleColsIncrease`、`handleColsDecrease`）を実装。
- Playwright のテスト対象となる要素に `data-testid` 属性を追加し、テストでの特定を容易にした。
- `tests/gridTab.spec.ts` に新しいテストケース「should update state when slider values change (Step 6-3)」を追加し、以下をテストできるようにした。
  - スライダーの初期値の確認。
  - 行数と列数スライダーの操作（値の増加・減少）に応じて状態が正しく更新されることの確認。
  - 式と計算結果の表示が状態の変化に連動して更新されることの確認。

### 今後の留意点

- Playwrightのテストでは、実際のDOM構造とセレクターが一致していることを確認する。特にクラス名を変更した場合は、テストのセレクターも必ず更新する。
- ブラウザ環境の問題（ライブラリ依存性エラーなど）が発生した場合でも、実装コード自体は機能していることが多いので、目視確認も併用する。
- テスト内でスライダーや入力フィールドを操作する際は、操作後に少し待機時間を設けると、非同期の状態更新が反映される可能性が高まる。
- スライダーのようなインタラクティブな要素をテストする場合、直接の値入力、矢印ボタン操作、ドラッグなど、複数の操作方法をテストすると堅牢性が増す。

## Step 6.3の追加修正: スライダードラッグ機能の改善 (2025/04/06)

### うまくいった手法

- 当初スライダーのドラッグ操作にいくつかの問題が発生していた：

  - 速くドラッグするとスライダーが追従できない
  - 開発者ツールの有無で挙動が変わる
  - クリックしていないのにマウスに追従してスライダーが動く

- 問題解決のアプローチ：

  1. まず `Slider.jsx` にドラッグ状態の管理とマウスイベントのロギングを実装
  2. 次に `Slider.css` でつまみ部分を 40px に大きくし、クリック範囲を拡大
  3. z-index を調整してつまみ部分が常に最前面に来るように変更
  4. これらのアプローチでも問題が解決しなかったため、最終的に根本的な変更を実施

- 最終的な解決策：

  - HTML のネイティブスライダー（`<input type="range">`）を使用せず、完全カスタム実装に変更
  - カスタムスライダーは以下の要素で構成：
    - トラック部分（クリック可能な背景バー）
    - フィル部分（進行度を表す塗りつぶし）
    - サム（つまみ）部分（ドラッグ可能な円形ノブ）
    - 実際の値を持つ隠し入力要素（テスト用）
  - マウスイベントを直接ハンドリングし、getBoundingClientRect() を使用してクリック位置から値を計算
  - 実際のドラッグ操作は document レベルのイベントリスナーで処理

- テストファイルの修正：
  - カスタムスライダーでは隠し入力要素を使用しているため、テストの要素選択方法を変更
  - クリック位置によって値が変わる可能性があるため、特定の値を期待するのではなく「値が変化したこと」をチェックするアプローチに変更

### 今後の留意点

- HTMLネイティブのドラッグ操作はブラウザや環境によって大きく挙動が異なるため、重要な機能はカスタム実装を検討する。
- 特に開発者ツールの有無で挙動が変わるバグは公式なテストで不具合が見つからない場合があるので注意が必要。
- テスト時には動的な要素に対しては固定的な値を期待するのではなく、相対的な変化やパターンマッチングをチェックする方がテストが安定する。
- 全体的な教訓として、複雑なUI要素は必要に応じて完全にカスタム実装することで、挙動の予測可能性と信頼性を高めることができる。

## Step 6.4: Canvasによる描画処理 (2025/04/06)

### うまくいった手法

- `GridTab.jsx` のUIと描画機能の最適化：

  - UIレイアウトの最適化：
    - 「グリッドタブ」ヘディングを削除し、よりコンパクトなレイアウトを実現
    - キャンバスサイズを500x500pxに統一し、表示領域を最適化
    - グリッドエリア、結果ラベル、スライダー間のマージンとパディングを調整
  - Canvas描画機能の実装：
    - `useRef` を使用したキャンバス要素への参照管理
    - 幅500px、高さ500pxの `canvas` 要素の実装
    - `drawGrid` 関数による以下の描画処理：
      - キャンバスの初期化とクリア
      - スライダー値（行数・列数）に基づくセルサイズの計算
      - 背景色の設定（薄いグレー #f0f0f0）
      - グリッド線の描画（垂直線と水平線、濃いグレー #333）
      - セルの塗りつぶし（薄い青色 rgba(100, 149, 237, 0.3）
      - 背景に水滴パターンの固定画像を追加
    - スライダー値の変更を検知し、自動的に再描画を行う `useEffect` フックの実装

- Playwrightテストの最適化：

  - UI要素の変更に合わせたテストケースの更新
  - キャンバス要素の存在確認テストの実装
  - キャンバス属性（width, height）の検証テストの追加
  - スライダー操作によるグリッド更新テストの実装
  - レイアウト最適化後のUI要素の配置確認テストの追加

- 最終的な検証：
  - `npm run dev` によるアプリケーションの起動
  - ユーザーによる目視確認
  - `npx playwright test` によるテスト実行
  - すべての機能が正常に動作することの確認

### 今後の留意点

- テスト時には動的な要素に対しては固定的な値を期待するのではなく、相対的な変化やパターンマッチングをチェックする方がテストが安定する。
- 全体的な教訓として、複雑なUI要素は必要に応じて完全にカスタム実装することで、挙動の予測可能性と信頼性を高めることができる。

## Step 7-1: グリッドの応用（分解）タブのUI作成 (2025/04/13)

### うまくいった手法

- `src/components/GridDecompositionTab.jsx` を作成し、基本的なUI要素（4つのスライダー、グリッド表示エリア、式表示エリア）を配置できた。
- `src/App.jsx` を修正し、`GridDecompositionTab` コンポーネントをタブUIに組み込めた。
- `GridTab.jsx` の実装を参考にして、スライダーの値を管理する状態を実装できた。
- `tests/gridDecompositionTab.spec.ts` を作成し、グリッド分解タブのUI要素が表示されることを確認する Playwright テストを記述できた。
- レイアウトの問題点を特定し、以下の修正を行った：
  - グリッド表示エリアを中央に配置し、左右のスライダーとのバランスを整えた。
  - 縦分割スライダーをグリッド表示エリアの上に適切に配置した。
  - 横分割スライダーをグリッド表示エリアの右に適切に配置した。
  - 式の表示位置を整理し、分割式を「式: 8 × 8 = 64」の上に配置した。
- Canvasによる描画処理を実装し、以下の機能を実現した：
  - グリッドの描画
  - 分割位置を示すオレンジ色のラインの追加
  - セルの色付け
- スライダーの改善を行った：
  - 分割スライダーのボタンを非表示にし、シンプルなデザインに変更した。
  - スライダーの範囲を0～10に変更し、より柔軟な調整を可能にした。
  - スライダーのポインタ位置を調整し、つまみの中心がスライダーの値の位置に正確に合うように修正した。
  - 分割スライダーと分割線の対応を直感的な向きに修正し、縦分割スライダーで縦分割線、横分割スライダーで横分割線が動くようにした。
- テストの修正を行った：
  - ボタンクリックのテストをスライダートラッククリックのテストに変更した。
  - 式の表示形式に合わせてテストを調整した。
  - `example.spec.ts`のテストを実際のUI要素に合わせて修正した。

## Step 7-1: バグ修正 (2025/04/14)

### うまくいった手法

- レスポンシブ対応の問題を修正した：
  - 縦分割スライダーの位置を調整し、グリッド表示エリアの上端から適切な距離に配置した。
  - 最上位のコンテナに`maxWidth: "1200px"`と`margin: "0 auto"`を追加して中央揃えにした。
  - 横分割スライダーの位置指定方法を`right`から`left`に変更し、適切な位置に配置した。
  - グリッド表示エリアのコンテナに`overflow: "hidden"`を追加して、はみ出した要素を隠すようにした。
  - これらの変更により、画面サイズを変更しても要素の位置関係が維持され、横スクロールバーも表示されなくなった。

### 今後の留意点

- スライダーの配置や回転などの複雑なレイアウトは、CSSのプロパティを注意深く設定する必要がある。
- グリッドの分割表示は、次のStep 7-3でより詳細に実装する必要がある。
- テストは、実際のレイアウトと一致していることを確認する必要がある。
- スライダーのポインタ位置の調整は、スライダーの実装に依存するため、スライダーコンポーネントを変更する場合は再度確認が必要。
- テストでボタンを使用している場合、UIの変更（ボタンの非表示化など）に合わせてテストも修正する必要がある。
- スライダーの操作と分割線の動きの対応は、ユーザーの直感に合わせることが重要。

## Step 7-2 追加修正 (2025/03/15)

### うまくいった手法

- 縦方向スライダーの値計算を修正して、上に行くほど値が大きくなるようにした。
- スライダーの幅を修正するために、`.vertical-slider-track`に`min-width: 2px !important`を追加して、`.slider-track`の`min-width: 100px`を上書きした。
- スライダーの長さと位置を調整して、見た目を改善した。

### 今後の留意点

- CSSの優先順位に注意すること。特に、汎用的なクラス（`.slider-track`など）が特定のコンポーネントに予期せぬ影響を与える可能性がある。
- 開発者ツールを使って、実際に適用されているCSSルールを確認することが重要。
- `!important`の使用は最小限にし、必要な場合のみ使用すること。

## Step 7-3: Canvasによる描画処理 (2025/04/13)

### うまくいった手法

1. 色弱者にも見やすい色の選定

   - 青、茶、紫、赤の組み合わせは色弱者にも識別しやすい
   - 黄色と背景色の組み合わせは避けるべき

2. 分割線の強調

   - 黒色の太い点線で分割線を表示することで視認性が向上

3. 分割された領域の計算式の表示
   - 分割線がグリッドの外にある場合の特別処理を実装
   - 有効な領域のみを式に含めることでわかりやすい表示に

### 今後の留意点

1. テストケースの設計

   - スライダーの値を直接設定する方法を実装することでテストの信頼性が向上
   - グローバル変数を使ってコンポーネントの状態管理関数を公開することでテストが容易に

2. 計算式の正確性
   - 式の基本形を明確にしておくことでバグを防止
   - 縦分割は横の数と比較、横分割は縦の数と比較することで正しい計算式を生成
   - デバッグログを活用して問題を特定しやすくする
